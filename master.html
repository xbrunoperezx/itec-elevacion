<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Librería XLS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- Importación de Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Tu propio CSS personalizado -->
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <title>SGASTUR - SGA Elevación 2</title>
  
</head>
<body>
    <!--creamos un contenedor para poder dibujar o escribir dentro de el con  una clase y una id (resultado sera el pincel)-->
    <div class="container" id="resultado">
        <h5>Clientes</h5>
    </div>

    <!--Creamos el boton para crear un nuevo cliente-->
    <a href="#!" class="btn green modal-trigger" data-target="modal-crear-cliente">
        Nuevo cliente
    </a>

    <!--Creamos el "contenedor" donde pintaremos la tabla con el JS-->
    <table class="none">
        <thead>
            <tr>
                <td>#</td>
                <td>Nombre</td>
                <td>Direccion</td>
                <td>Localidad</td>
                <td>Mantenedor</td>
                <td>Cp</td>
                <td>Vencimiento</td>
                <td>Contratada</td>
                <td>Acciones</td>
                
            </tr>
        </thead>

        <tbody id="tabla-clientes"> <!--el pincel con el que pintaremos ahroa sera "tabla-clientes"-->
            <!--aqui con este id es en el que con la funcion en JS isnertaremos todos los clientes-->
        </tbody>
    </table>

    <!--           MODAL DE VER CLIENTE             -->
    <!--Creamos al estructura completa del modal/ventana emergente-->
    <div id="modal-cliente" class="modal">
        <div class="modal-content">
            <h4>Detalles del cliente</h4>

            <p><strong>Nombre:</strong><span id="m-nombre"></span></p>
            <p><strong>Direccion:</strong><span id="m-direccion"></span></p>
            <p><strong>Localidad:</strong><span id="m-localidad"></span></p>
            <p><strong>Mantenedor:</strong><span id="m-mantenedor"></span></p>
            <p><strong>CP:</strong><span id="m-cp"></span></p>

        </div>

        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey">Cerrar</a>
        </div>
    </div>

    <!--          MODAL EDITAR CLIENTE-->
    <!--creamos la estructura completa del modal/ventana emergente -->
    <div id="modal-editar-cliente" class="modal">
        <div class="modal-content">
            <h4>Editar cliente</h4>

            <input type="hidden" id="edit-id">

            <div class="input-field">
                <input type="text" id="edit-nombre">
                <label for="edit-nombre">Nombre</label>
            </div>

            <div class="input-field">
                <input type="text" id="edit-direccion">
                <label for="edit-direccion">Dirección</label>
            </div>

            <div class="input-field">
                <input type="text" id="edit-localidad">
                <label for="edit-localidad">Localidad</label>
            </div>

            <div class="input-field">
                <select id="edit-mantenedor">
                    <option value="" disabled>Elige un mantenedor</option>
                </select>
                <label>Mantenedor</label>
            </div>

            <div class="input-field">
                <input type="text" id="edit-cp">
                <label for="edit-cp">CP</label>
            </div>

            <div class="input-field">
                <input type="date" id="edit-vencimiento">
                <label for="edit-vencimiento">Vencimiento</label>
            </div>

            <p>
                <label>
                    <input type="checkbox" id="edit-contratada">
                    <span>Contrato activo</span>
                </label>
            </p>

        </div>

        <div class="modal-footer">
            <a href="#!" class="btn-green" id="guardar-cambios">Guardar</a>
            <a href="#!" class="modal-close btn grey">Cancelar</a>
        </div>
    </div>   
    
    <!--          MODAL CREAR CLIENTE-->
    <!--cREAMOS LA ESTRUCTURA DEL MODA/VENTANA EMERGENTE PARA EL  CREAR CLIENTE-->
    
    <div id="modal-crear-cliente" class="modal">
        <div class="modal-content">
            <h4>Nuevo cliente</h4>

            <div class="input-field">
                <input type="text" id="create-nombre">
                <label for="create-nombre">Nombre</label>
            </div>

            <div class="input-field">
                <input type="text" id="create-direccion">
                <label for="create-direccion">Dirección</label>
            </div>

            <div class="input-field">
                <input type="text" id="create-localidad">
                <label for="create-localidad">Localidad</label>
            </div>

             <div class="input-field">
                <input type="text" id="create-municipio"  name="municipio">
                <label for="create-municipio">Municipio</label>
            </div>

             <div class="input-field">
                <select id="create-mantenedor">
                    <option value="" disabled selected>Elige un mantenedor</option>
                    
                    
                </select>
            </div>

            <div class="input-field">
                <input type="text" id="create-cp">
                <label for="create-cp">CP</label>
            </div>

        </div>

        <div class="modal-footer">
            <a href="#!" class="btn green" id="crear-cliente">Crear</a>
            <a href="#!" class="modal-close btn grey">Cancelar</a>
        </div>
    </div>


    
    <!--Scrip de peticion back via ajax-->
    <script>
        //creamos una variable acessible desde cualquier punto del programa que en ella recogeremos el array de clientes del back
        let clientesGlobal=[];
        let mantenedoresGlobal=[];
       
        $(document).ready(function(){  //cargamos la web (el JS) nada mas acceder a la Url
            $.ajax({ //aqui hacemos la peticion de los datos al back (ajax no recarga la pagina)
                //donde lo llamo 
                type:"POST",
                //como lo llamo
                url:"services/clientes.php", 
                //que mando
                data:{  
                    filtro_total: 15
                },
                //que hago cuando vuelve? ->successs/error
                dataType: "json",
                success: function(response){ //el response es el objeto que vi en POSTMAN la respuesta en JSON
                    //aqui llega la respuesta el JSON

                    // 1º  ----pinto en consola-----
                    //console.log(response)

                    //2º  ----muestro un parrafo en el contenedor del div creado  por la id resultado.----
                    //$('#resultado').html('<p>Hola, el js funciona </p>')

                    //3º  --- ahora filtro  que cliente  quiero mostrar en  la  posicion----
                    //let cliente= response.resultados[0];

                    //--- aqui elijo que datos quiero mostrar/pintar llamando a cliente siempre---
                    //let html= `

                        //<p> 
                            //<strong>Nombre:</strong> ${cliente.nombre}<br>
                            //<strong>direccion:</strong> ${cliente.direccion}
                        //</p>    
                    //`;

                    //---muestro los dos clientes en parrafos con su nombre y direccion
                    //$('#resultado').html(html)

                    
                    //guardamos  el array de clientes traidos del back, en la variable local
                    clientesGlobal=response.resultados;
                    mantenedoresGlobal=response.mantenedores;

                    //lo mismo que pintar clientes pero con option el SELECT DE CREAR, ara que mediante su id saquemosel nombre para pintarlo en tabla
                    let opciones= '<option value="" disabled selected>Elige un mantenedor</option>';
                    for(let id in mantenedoresGlobal){
                        opciones+= `<option value="${id}">${mantenedoresGlobal[id]}</option>`
                    }

                    $('#create-mantenedor').html(opciones);
                    $('select').formSelect(); // Materializwe


                    //para rellenar el SELECT DE EDITAR/UPDATE , para que mediante su id saquemosel nombre para pintarlo en tabla
                    let opcionesEdit= '<option value="" disabled>Elige un mantenedor</option>';
                    for(let id in mantenedoresGlobal){
                        opcionesEdit+= `<option value="${id}">${mantenedoresGlobal[id]}</option>`;
                    }

                    $('#edit-mantenedor').html(opcionesEdit);
                    $('selec').formSelect();

                    //4º  ---creamos un acumulador para no sobrescribir cada vuelta el cliente---
                    let html = "";
                    let contador = 1;
                    //recorremos el array "response.resultados" con cada cliente
                    response.resultados.forEach(function(cliente){
                        let vencimiento= cliente.vencimiento_dmy ?? '-';
                        let contratadaTexto= cliente.contratada == 1 ? 'v' : '-';
                         
                        //con el acumulador creado vamos añadiendo al html cada iteraccion del bucle un cliente 
                        html += `
                            <tr data-id="${cliente.id}">
                                <td>${contador}</td> 
                                <td>${cliente.nombre}</td>
                                <td>${cliente.direccion}</td>
                                <td>${cliente.localidad}</td>
                                <td>${cliente.mantenedor}</td>
                                <td>${cliente.cp}</td>
                                <td>${cliente.vencimiento}</td>
                                <td>${cliente.contratada}</td>
                                <td>
                                    <a href="#" class="btn-small blue ver-cliente" data-id="${cliente.id}"> 
                                        <i class="material-icons">Ver</i>
                                    </a>
                                    
                                    <a href="#" class="btn-small orange editar-cliente" data-id="${cliente.id}">
                                        <i class="materialize-icons">Editar</i>
                                    </a>
                                    
                                    <a href="#" class="btn-small red eliminar-cliente" data-id="${cliente.id}">
                                        <i class="materialize-icons">Borrar</i>
                                    </a>    

                                    
                                </td>


                            </tr>     
                        `;

                        contador ++;
                    });
                    
                    $('#tabla-clientes').html(html); // este es el pincel de js con el que mostramos en pantalla los resultados
                }
               
              //cierre de ajax
            })

          //inicializamos el modal, por que si no no existe
          $('.modal').modal();

          //inicializamos el select
          $('select').formSelect();

          //------------------------------------------------------------
          //FUNCION comprobar que funciona el boton y muestra el ID(VER)
          $(document).on('click', '.ver-cliente', function(e){
            e.preventDefault();

            let id=$(this).data('id'); //esto era solo para mostrar el id con un console.log que habia echo
            
          /* 1º manera de recorrer clientes y buscar por id
          let clienteEncontrado = null;
            clientesGlobal.forEach(function(cliente){
                if(cliente.id ==id){
                    clienteEncontrado=cliente;
                }
            });
          */
            
          // 2º manera de hacerlo mas limpio con .find
            let cliente=clientesGlobal.find(c => c.id == id);

            //ahora pintamos los datos del modal cogiendo la id que creamos en el html
            $('#m-nombre').text(cliente.nombre);
            $('#m-direccion').text(cliente.direccion);
            $('#m-localidad').text(cliente.localidad);
            $('#m-mantenedor').text(cliente.mantenedor);
            $('#m-cp').text(cliente.cp);

            //abrimos el modal con el id creado arriba en el html en el div general
            $('#modal-cliente').modal('open');
          });

          //--------------------------------------------------------------
          //FUNCION comprobar que funciona el boton y muestra el ID(EDITAR/UPDATE)
          $(document).on('click', '.editar-cliente', function(e){
            e.preventDefault();

            let id= $(this).data('id');// saber que boton e pulsado
            let cliente= clientesGlobal.find(c => c.id == id);

            $('#edit-id').val(cliente.id);
            $('#edit-nombre').val(cliente.nombre);
            $('#edit-direccion').val(cliente.direccion);
            $('#edit-localidad').val(cliente.localidad);
            $('#edit-mantenedor').val(cliente.id_mantenedor);
            $('#edit-cp').val(cliente.cp);
            $('#edit-vencimiento').val(cliente.vencimiento);
            $('#edit-contratada').prop('checked', cliente.contratada == 1);
            $('select').formSelect();

            M.updateTextFields();//para mover las etiquetas de label si esta vacio o no el input
            $('#modal-editar-cliente').modal('open');
           
          });

          //----------------------------------------------------------------
          //FUNCION para guardar cambios de ese cliente que hemos editado(BOTON GUARDAR)
          $('#guardar-cambios').on('click', function(){  

            // construimos el objeto que guarda los datos para logo enviarlo por ajax
            // que es lo que espera PHP por $_POST
            let datos ={
                id: $('#edit-id').val(),
                nombre: $('#edit-nombre').val(),
                direccion: $('#edit-direccion').val(),
                localidad: $('#edit-localidad').val(),
                id_mantenedor: $('#edit-mantenedor').val(),
                cp: $('#edit-cp').val(),
                vencimiento: $('#edit-vencimiento').val(),
                contratada: $('#edit-contratada').is(':checked') ? 1 : 0
               
            };

            $.ajax({
                url: 'services/clientes_update.php',
                type: 'POST',
                data: datos,
                dataType: 'json',
                success: function(response){
                    if(response.success){
                        
                        //buscamos el cliente en el array global que  sea igual que el que acabo de editar
                        cliente= clientesGlobal.find(c=> c.id == datos.id);



                        //actualizamos con los nuevos datos del cliente para que no sea la de antes (Desfasada)
                        cliente.nombre= datos.nombre;
                        cliente.direccion= datos.direccion;
                        cliente.localidad= datos.localidad;
                        cliente.id_mantenedor= datos.id_mantenedor;
                        cliente.cp= datos.cp;
                        cliente.vencimiento= datos.vencimiento;
                        cliente.contratada= datos.contratada;
                       

                        //con esto nos devuelve el nombre y no la ID(busca en el array global usando la id y nos devuelve su nombre)
                        cliente.mantenedor= mantenedoresGlobal[datos.id_mantenedor];
                        //---
                        let textoContratada= cliente.contratada == 1 ? 'v' : '-';

                        //buscamos la fila en la tabla del cliente que editamos
                        let fila= $(`tr[data-id= "${datos.id}"]`);

                        //actualizamos ahora solo la fila que editamos
                        fila.find('td').eq(1).text(cliente.nombre);
                        fila.find('td').eq(2).text(cliente.direccion);
                        fila.find('td').eq(3).text(cliente.localidad);
                        fila.find('td').eq(4).text(cliente.mantenedor);
                        fila.find('td').eq(5).text(cliente.cp);
                        fila.find('td').eq(6).text(cliente.vencimiento);
                        fila.find('td').eq(7).text(cliente.textoContratada);
                        

                        //cerramos el modal/ventana por que ya se guardo cliente
                        $('#modal-editar-cliente').modal('close'); 
                    }    
            
                    
                }
            });
          });


          //-----------------------------------------------------------------
          //FUNCION para crear un nuevo cliente (BOTON CREAR CLIENTE)
          $('#crear-cliente').on('click', function(){
            
                let datos= {
                    nombre: $('#create-nombre').val(),
                    direccion: $('#create-direccion').val(),
                    localidad: $('#create-localidad').val(),
                    municipio: $('#create-municipio').val(),
                    id_mantenedor: $('#create-mantenedor').val(),
                    cp: $('#create-cp').val()

                };

                $.ajax({
                    url:'services/clientes_create.php',
                    type: 'POST',
                    data: datos,
                    dataType: 'json',
                    success: function(response){
                        if(response.success){
                            alert(response.message);

                            //aqui añadimos el nuevo cliente con el metodo .unshift lo añadimos al principio del array de clientesGlobal
                            //si quisiesmos añadirlo al final seria con .push, pero por logica qeremos que se vea el primero
                            clientesGlobal.unshift(response.cliente);

                            //ahora solo vamos a pintar la nueva fila con los datos de ese cliente
                            let cliente= response.cliente;

                            //para verificar si existe dame nombre, si no "-", quitar errores
                            cliente.mantenedor= mantenedoresGlobal[cliente.id_mantenedor] ?? '-';

                            let nuevaFila= `
                                 <tr data-id="${cliente.id}">
                              
                                    <td>${cliente.nombre}</td>
                                    <td>${cliente.direccion}</td>
                                    <td>${cliente.localidad}</td>
                                    <td>${cliente.mantenedor}</td>
                                    <td>${cliente.cp}</td>
                                    <td>
                                        <a href="#" class="btn-small blue ver-cliente" data-id="${cliente.id}"> 
                                            i class="material-icons">Ver</i>
                                        </a>
                                    
                                        <a href="#" class="btn-small orange editar-cliente" data-id="${cliente.id}">
                                            <i class="materialize-icons">Editar</i>
                                        </a>
                                    
                                        <a href="#" class="btn-small red eliminar-cliente" data-id="${cliente.id}">
                                            <i class="materialize-icons">Borrar</i>
                                        </a>    
                                    </td>
                                </tr> 
                            `;

                            //para que los neuvos datos aparezcan insertados enla primera fila .prepend
                            $('#tabla-clientes').prepend(nuevaFila);

                            //ahora limpiamos el formulario
                            $('#modal-crear-cliente input').val('');
                            M.updateTextFields();


                            //cerramos el modal
                            $('#modal-crear-cliente').modal('close');
                           
                        } else {
                            alert(response.message);
                        }

                    }


                });
            });
        


            //----------------------------------------------------------------
            //FUNCION comprobar que funciona el boton y muestra el ID(ELIMINAR)
            $(document).on('click', '.eliminar-cliente', function(e){
                e.preventDefault();

                let id=$(this).data('id');//comprobamos que el data-id coincide

                // creamos una condicional para que no borremos por error que nos aparezca un mensaje de confirmacion
                if(confirm('¿Seguro que quieres eliminar este cliente?')){
                    $.ajax({
                        type: "POST",
                        url: "services/clientes_delete.php",
                        data: { id: id},
                        dataType: "json",
                        success: function(response){
                            if(response.success){
                                //sobreescribimos el array de clientes paraque solo mantenga los que no queremos borrar
                                clientesGlobal= clientesGlobal.filter(c=> c.id != id);

                                //ahora buscamos la fila de ese cliente "<tr>" que tenga ese data-id y es la que eliminamos
                                $(`tr[data-id="${id}"]`).remove();  
                                
                                alert(response.message);
                            } else {
                                alert(response.message);
                            }
                        }
                      
                    });
                }
           
            });       
           
         
        
        
         //cierre de la funcion de carga $(document).rea..
        });

        

        
    </script>
</body>
</html>